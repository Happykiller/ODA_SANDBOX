<ul class="nav nav-pills" id="navBarSets">
</ul>

<br>

<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading"><span oda-label="rapports-cartes.metrics-coll"></span></div>
            <div class="panel-body">
                <div class="row">
                    <div class="col-md-8" id="div_metrics_collection">
                        <oda-loading></oda-loading>
                    </div>
                    <div class="col-md-4" id="div_metrics_collection_neutre">
                        <oda-loading></oda-loading>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading"><span oda-label="home.mectrics"></span></div>
            <div class="panel-body">
                <div class="row">
                    <div class="col-md-6" id="div_metrics_paquets">
                        <oda-loading></oda-loading>
                    </div>
                    <div class="col-md-6" id="div_metrics_dropRate">
                        <oda-loading></oda-loading>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading"><span oda-label="rapports-cartes.infos-packet"></span></div>
            <div class="panel-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="row">
                            <div class="col-md-3" id="div_drop_classique">
                                <oda-loading></oda-loading>
                            </div>
                            <div class="col-md-3" id="div_drop_rare">
                                <oda-loading></oda-loading>
                            </div>
                            <div class="col-md-3" id="div_drop_epique">
                                <oda-loading></oda-loading>
                            </div>
                            <div class="col-md-3" id="div_drop_legendaire">
                                <oda-loading></oda-loading>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12" id="div_best_paquets">
                        <oda-loading></oda-loading>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    /**
     * Build NavBar Sets
     */
    function buildNavBarSets(){
        try {
            var strHtml = '';
            for (var indice in $.Oda.App.tab_sets) {
                if($.Oda.Storage.get('ODA-HOW_currentSet',0) == indice){
                    strHtml += '<li role="presentation" class="active"><a>'+ $.Oda.App.tab_sets[indice]+'</a></li>';
                }else{
                    strHtml += '<li role="presentation"><a href="javascript:changerSet('+indice+')">'+$.Oda.App.tab_sets[indice]+'</a></li>';
                }
            }
            $('#navBarSets').html(strHtml);
        } catch (er) {
            $.Oda.Log.error("buildNavBarSets : " + er.message);
        }
    }

    function changerSet(idSet) {
        try {
            $.Oda.Storage.set('ODA-HOW_currentSet', idSet);
            buildNavBarSets();
            $.Oda.Display.loading({elt : $('#div_metrics_dropRate')});
            monWorker.postMessage(new $.Oda.Worker.message('start', { "color" : $.Oda.Color, set : $.Oda.App.tab_sets[$.Oda.Storage.get('ODA-HOW_currentSet')] }));
            chargerMetricsCollection();
            chargerMetricsCollectionNeutre();
            chargerMetricsPaquets();
            chargerDrop('classique');
            chargerDrop('rare');
            chargerDrop('epique');
            chargerDrop('legendaire');
            chargerBestPaquets();
        } catch (er) {
            $.Oda.Log.error("changerSet : " + er.message);
        }
    }

    var monWorker = $.Oda.Worker.initWorker("monWorker", {}, function(){
        function messageHandler(event) {
            try {
                // On récupère le message envoyé par la page principale
                var messageSent = event.data;

                // On teste la commande envoyée
                switch (messageSent.cmd) {
                    case 'start':
                        var strhtml = "";

                        //COMMUN
                        var tabInput = { set : messageSent.parameter.set };
                        var json_retour_qualitePaquets = $Oda.callRest($Oda.Context.rest+"phpsql/getQualitePaquets.php", {}, tabInput);

                        if((json_retour_qualitePaquets["strErreur"] === "")&&(json_retour_qualitePaquets["strErreur"] === "")){
                            var nbPaquets = parseInt(json_retour_qualitePaquets["data"]["nbpaquets"]["nb"]);
                            var repartitionQualite = json_retour_qualitePaquets["data"]["repartitionQualite"]["data"];

                            var dropRate_comm = 0;
                            var dropRate_rare = 0;
                            var dropRate_epic = 0;
                            var dropRate_legend = 0;
                            var dropRate_gold = 0;

                            var total = 0;
                            for (var indice in repartitionQualite){
                                total += parseInt(repartitionQualite[indice]["nb"]);
                            }

                            for (var indice in repartitionQualite){
                                switch (repartitionQualite[indice]["qualite"]){
                                    case "Commune":
                                        dropRate_comm = $Oda.arrondir(parseInt(repartitionQualite[indice]["nb"]) / total * 100,2);
                                        break;
                                    case "Rare":
                                        dropRate_rare = $Oda.arrondir(parseInt(repartitionQualite[indice]["nb"]) / total * 100,2);
                                        break;
                                    case "Épique":
                                        dropRate_epic = $Oda.arrondir(parseInt(repartitionQualite[indice]["nb"]) / total * 100,2);
                                        break;
                                    case "Légendaire":
                                        dropRate_legend = $Oda.arrondir(parseInt(repartitionQualite[indice]["nb"]) / total * 100,2);
                                        break;
                                }
                            }

                            dropRate_gold = $Oda.arrondir(parseInt(json_retour_qualitePaquets["data"]["repartitionGold"]["nb"]) / total * 100,2);

                        }else{
                            $Oda.log("Erreur : "+json_retour_qualitePaquets["strErreur"]);
                        }

                        strhtml += 'Chance au tirage g&eacute;n&eacute;ral : ';
                        strhtml += '<ul>';
                        strhtml += '<li>Chance au tirage des communes : '+dropRate_comm+'%</li>';
                        strhtml += '<li>Chance au tirage des rares : '+dropRate_rare+'%</li>';
                        strhtml += '<li>Chance au tirage des &eacute;piques : '+dropRate_epic+'%</li>';
                        strhtml += '<li>Chance au tirage des l&eacute;gendraires : '+dropRate_legend+'%</li>';
                        strhtml += '<li>Chance au tirage des dor&eacute;es : '+dropRate_gold+'%</li>';
                        strhtml += '<li>Sur '+nbPaquets+' paquets.</li>';
                        strhtml += '</ul>';

                        //PERSO
                        var tabInput = { code_user : $Oda.Session.code_user, set : messageSent.parameter.set };
                        var json_retour_dropRate = $Oda.callRest($Oda.Context.rest+"phpsql/getMetricsDropRate.php", {}, tabInput);

                        var json_retour_qualitePaquets = $Oda.callRest($Oda.Context.rest+"phpsql/getQualitePaquets.php", {}, tabInput);

                        if((json_retour_dropRate["strErreur"] === "")&&(json_retour_qualitePaquets["strErreur"] === "")){
                            var nbPaquets = parseInt(json_retour_qualitePaquets["data"]["nbpaquets"]["nb"]);
                            var repartitionQualite = json_retour_qualitePaquets["data"]["repartitionQualite"]["data"];
                            var metricsDez = json_retour_dropRate["data"]["resultatDez"]["data"];
                            var metricsAvancement = json_retour_dropRate["data"]["resultatAvan"]["data"];

                            var dropRateCommune = 0;
                            var dropRateRare = 0;
                            var dropRateEpique = 0;
                            var dropRateLegendaire = 0;

                            var total = 0;
                            for (var indice in repartitionQualite){
                                total += parseInt(repartitionQualite[indice]["nb"]);
                            }

                            for (var indice in repartitionQualite){
                                switch (repartitionQualite[indice]["qualite"]){
                                    case "Commune":
                                        dropRateCommune = $Oda.arrondir(parseInt(repartitionQualite[indice]["nb"]) / total * 100,2);
                                        break;
                                    case "Rare":
                                        dropRateRare = $Oda.arrondir(parseInt(repartitionQualite[indice]["nb"]) / total * 100,2);
                                        break;
                                    case "Épique":
                                        dropRateEpique = $Oda.arrondir(parseInt(repartitionQualite[indice]["nb"]) / total * 100,2);
                                        break;
                                    case "Légendaire":
                                        dropRateLegendaire = $Oda.arrondir(parseInt(repartitionQualite[indice]["nb"]) / total * 100,2);
                                        break;
                                }
                            }

                            var percDezCommune = 0;
                            var percDezRare = 0;
                            var percDezEpique = 0;
                            var percDezLegendaire = 0;
                            var percDezGold = 0;
                            for (var indice in metricsDez){
                                switch (metricsDez[indice]["qualite"]){
                                    case "Commune":
                                        percDezCommune = parseFloat(metricsDez[indice]["percDez"]);
                                        break;
                                    case "Rare":
                                        percDezRare = parseFloat(metricsDez[indice]["percDez"]);
                                        break;
                                    case "Épique":
                                        percDezEpique = parseFloat(metricsDez[indice]["percDez"]);
                                        break;
                                    case "Légendaire":
                                        percDezLegendaire = parseFloat(metricsDez[indice]["percDez"]);
                                        break;
                                    case "gold":
                                        percDezGold = parseFloat(metricsDez[indice]["percDez"]);
                                        break;
                                }
                            }

                            var strAvCommune = 0;
                            var strAvRare = 0;
                            var strAvEpique = 0;
                            var strAvLegendaire = 0;
                            for (var indice in metricsAvancement){
                                switch (metricsAvancement[indice]["qualite"]){
                                    case "Commune":
                                        var restCommune = parseInt(metricsAvancement[indice]["rest"]);
                                        strAvCommune = 'reste : '+restCommune+' pour : '+parseInt(metricsAvancement[indice]["nbMy"])+'/'+(parseInt(metricsAvancement[indice]["nbInv"])*2)+', soit : '+parseFloat(metricsAvancement[indice]["avancement"])+'%';
                                        break;
                                    case "Rare":
                                        var restRare = parseInt(metricsAvancement[indice]["rest"]);
                                        strAvRare = 'reste : '+restRare+' pour : '+parseInt(metricsAvancement[indice]["nbMy"])+'/'+(parseInt(metricsAvancement[indice]["nbInv"])*2)+', soit : '+parseFloat(metricsAvancement[indice]["avancement"])+'%';
                                        break;
                                    case "Épique":
                                        var restEpique = parseInt(metricsAvancement[indice]["rest"]);
                                        strAvEpique = 'reste : '+restEpique+' pour : '+parseInt(metricsAvancement[indice]["nbMy"])+'/'+(parseInt(metricsAvancement[indice]["nbInv"])*2)+', soit : '+parseFloat(metricsAvancement[indice]["avancement"])+'%';
                                        break;
                                    case "Légendaire":
                                        var restLegendaire = parseInt(metricsAvancement[indice]["rest"]);
                                        strAvLegendaire = 'reste : '+restLegendaire+' pour : '+parseInt(metricsAvancement[indice]["nbMy"])+'/'+parseInt(metricsAvancement[indice]["nbInv"])+', soit : '+parseFloat(metricsAvancement[indice]["avancement"])+'%';
                                        break;
                                }
                            }

                            var burnDownCommune = $Oda.arrondir((restCommune*100)/(dropRateCommune*percDezCommune/100)/5,0);
                            var burnDownRare = $Oda.arrondir((restRare*100)/(dropRateRare*percDezRare/100)/5,0);
                            var burnDownEpique = $Oda.arrondir((restEpique*100)/(dropRateEpique*dropRateEpique/100)/5,0);
                            var burnDownLegendaire = $Oda.arrondir((restLegendaire*100)/(dropRateLegendaire*dropRateLegendaire/100)/5,0);

                            strhtml += 'Vos statistiques de tirage : ';
                            strhtml += '<ul>';

                            if(dropRateCommune >= dropRate_comm){
                                var color = messageSent.parameter.color.SUCCESS;
                            }else{
                                var color = messageSent.parameter.color.WARNING;
                            }
                            strhtml += '<li style="color:'+color+';">Taux de tirage des communes : '+dropRateCommune+'% ('+percDezCommune+'% Dez)</li>';

                            if(dropRateRare >= dropRate_rare){
                                var color = messageSent.parameter.color.SUCCESS;
                            }else{
                                var color = messageSent.parameter.color.WARNING;
                            }
                            strhtml += '<li style="color:'+color+';">Taux de tirage des rares : '+dropRateRare+'% ('+percDezRare+'% Dez)</li>';

                            if(dropRateEpique >= dropRate_epic){
                                var color = messageSent.parameter.color.SUCCESS;
                            }else{
                                var color = messageSent.parameter.color.WARNING;
                            }
                            strhtml += '<li style="color:'+color+';">Taux de tirage des &eacute;piques : '+dropRateEpique+'% ('+percDezEpique+'% Dez)</li>';

                            if(dropRateLegendaire >= dropRate_legend){
                                var color = messageSent.parameter.color.SUCCESS;
                            }else{
                                var color = messageSent.parameter.color.WARNING;
                            }
                            strhtml += '<li style="color:'+color+';">Taux de tirage des l&eacute;gendaires : '+dropRateLegendaire+'% ('+percDezLegendaire+'% Dez)</li>';

                            var myDropRateGold = $Oda.arrondir(parseFloat(json_retour_dropRate["data"]["resultat"]["dropRate_gold"]),2);
                            if(myDropRateGold >= dropRate_gold){
                                var color = messageSent.parameter.color.SUCCESS;
                            }else{
                                var color = messageSent.parameter.color.WARNING;
                            }
                            strhtml += '<li style="color:'+color+';">Taux de tirage des dor&eacute;es : '+myDropRateGold+'% ('+percDezGold+'% Dez)</li>';

                            strhtml += '<li>Sur '+nbPaquets+' paquets.</li>';
                            strhtml += '</ul>';

                            strhtml += 'Votre avancement : ';
                            strhtml += '<ul>';
                            strhtml += '<li>Pour les communes => '+strAvCommune+'</li>';
                            strhtml += '<li>Pour les rares => '+strAvRare+'</li>';
                            strhtml += '<li>Pour les &eacute;piques => '+strAvEpique+'</li>';
                            strhtml += '<li>Pour les l&eacute;gendaires => '+strAvLegendaire+'</li>';
                            strhtml += '</ul>';

                            strhtml += 'Votre burn down pour finir collection : ';
                            strhtml += '<ul>';
                            strhtml += '<li>Pour les communes => '+burnDownCommune+' paquets &agrave; ouvrir</li>';
                            strhtml += '<li>Pour les rares => '+burnDownRare+' paquets &agrave; ouvrir</li>';
                            strhtml += '<li>Pour les &eacute;piques => '+burnDownEpique+' paquets &agrave; ouvrir</li>';
                            strhtml += '<li>Pour les l&eacute;gendaires => '+burnDownLegendaire+' paquets &agrave; ouvrir</li>';
                            strhtml += '</ul>';

                            this.postMessage(new $Oda.message('resultat',{"html" : strhtml}));
                        } else{
                            $Oda.log("Erreur : "+json_retour_dropRate["strErreur"]+", "+json_retour_qualitePaquets["strErreur"]);
                        }

                        break;
                }
            }catch (er) {
                this.postMessage("Erreur : " + er.message);
            }
        }

        // On définit la fonction à appeler lorsque la page principale nous sollicite
        this.addEventListener('message', messageHandler, false);
    },function(msg){
        if(msg.cmd === "resultat") {
            $('#div_metrics_dropRate').html(msg.parameter.html);
        }
    });

    /**
     * chargerMetricsCollection
     */
    function chargerMetricsCollection(){
        try {
            $.Oda.Display.loading({elt : $('#div_metrics_collection')});
            var tabSetting = { functionRetour : function(datas){
                if(datas["strErreur"] == ""){

                    //Classes
                    var categories = new Array();
                    categories = $.Oda.Tooling.getListValeurPourAttribut(datas["data"]["classes"]["data"],"classe");

                    //Pour chaque qualités, le nombre présent dans chaque classe qualite_classe
                    //Pour chaque tranche, le nombre pour chaque categorie, même à 0
                    var series = new Array();
                    var seriesData = datas["data"]["qualite_classe"]["data"];

                    var oldSubserie = null;
                    var subDatas = { name : null};
                    subDatas.data = new Array();
                    for (var indice in seriesData) {
                        if(oldSubserie != seriesData[indice]["qualite"]){
                            if(subDatas.data.length != 0){
                                series[series.length] = subDatas;
                            }
                            subDatas = {
                                name : seriesData[indice]["qualite"]
                                , color : $.Oda.App.colorCard[seriesData[indice]["qualite"]]
                                , stack: 'myCollection'
                            };
                            subDatas.data = new Array();
                            oldSubserie = seriesData[indice]["qualite"];
                        }
                        subDatas.data[subDatas.data.length] = parseInt(seriesData[indice]["nb"]);
                    }
                    series[series.length] = subDatas;

                    var seriesData = datas["data"]["qualite_classe_inventaire"]["data"];

                    var oldSubserie = null;
                    var subDatas = { name : null};
                    subDatas.data = new Array();
                    for (var indice in seriesData) {
                        if(oldSubserie != seriesData[indice]["qualite"]){
                            if(subDatas.data.length != 0){
                                series[series.length] = subDatas;
                            }
                            subDatas = {
                                name : seriesData[indice]["qualite"]
                                , color : $.Oda.App.colorCard[seriesData[indice]["qualite"]+'_inv']
                                , stack: 'inventaire'
                            };
                            subDatas.data = new Array();
                            oldSubserie = seriesData[indice]["qualite"];
                        }
                        subDatas.data[subDatas.data.length] = parseInt(seriesData[indice]["nb"]);
                    }
                    series[series.length] = subDatas;

                    var retour = $('#div_metrics_collection').highcharts({
                        chart: {
                            backgroundColor:'rgba(255, 255, 255, 0.1)'
                            , type : "column"
                        },
                        title: {
                            text: 'Répartition des cartes en qualité'
                        },
                        xAxis: {
                            categories: categories
                        },
                        yAxis: {
                            min: 0,
                            title: {
                                text: 'Total par classe'
                            },
                            stackLabels: {
                                enabled: true,
                                style: {
                                    fontWeight: 'bold',
                                    color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
                                }
                            }
                        },
                        legend: {
                            align: 'right',
                            x: -70,
                            verticalAlign: 'top',
                            y: 20,
                            floating: true,
                            backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColorSolid) || 'white',
                            borderColor: '#CCC',
                            borderWidth: 1,
                            shadow: false
                        },
                        tooltip: {
                            useHTML: true,
                            formatter: function() {
                                var s;
                                s = this.key+','+this.series.name +' : '+this.y+', '+$.Oda.Tooling.arrondir((this.y / this.point.stackTotal * 100),2)+'% (<a href="javascript:openMissedCards({\'classe\':\''+this.key+'\',\'qualite\':\''+this.series.name+'\'});">Manquante(s)</a>)';
                                return s;
                            }
                        },
                        plotOptions: {
                            column: {
                                stacking: 'normal',
                                dataLabels: {
                                    enabled: true,
                                    color: 'white',
                                    formatter: function() {
                                        var s;
                                        if(this.y != 0){
                                            s = this.y;
                                        }
                                        return s;
                                    }
                                }
                            }
                        },
                        series: series
                    });
                } else{
                    $.Oda.Display.Notification.error(datas["strErreur"]);
                }
            }};
            var tabInput = { code_user : $.Oda.Session.code_user, set : $.Oda.App.tab_sets[$.Oda.Storage.get('ODA-HOW_currentSet')] };
            $.Oda.Interface.callRest($.Oda.Context.rest+"phpsql/getMetricsCollection.php", tabSetting, tabInput);
        } catch (er) {
            $.Oda.Log.error("chargerMetricsCollection : " + er.message);
        }
    }

    /**
     * chargerMetricsCollectionNeutre
     */
    function chargerMetricsCollectionNeutre(){
        try {
            $.Oda.Display.loading({elt : $('#div_metrics_collection_neutre')});
            var tabSetting = { functionRetour : function(datas){
                if(datas["strErreur"] == ""){

                    var nbCommColl = (datas["data"]["qualite_neutre"]["data"][0] != undefined) ? parseInt(datas["data"]["qualite_neutre"]["data"][0]["nb"]) : 0;
                    var nbCommInv = (datas["data"]["qualite_neutre_inventaire"]["data"][0] != undefined) ? parseInt(datas["data"]["qualite_neutre_inventaire"]["data"][0]["nb"]) : 0;

                    var nbRareColl = (datas["data"]["qualite_neutre"]["data"][3] != undefined) ? parseInt(datas["data"]["qualite_neutre"]["data"][3]["nb"]) : 0;
                    var nbRareInv = (datas["data"]["qualite_neutre_inventaire"]["data"][3] != undefined) ? parseInt(datas["data"]["qualite_neutre_inventaire"]["data"][3]["nb"]) : 0;

                    var nbEpiqueColl = (datas["data"]["qualite_neutre"]["data"][1] != undefined) ? parseInt(datas["data"]["qualite_neutre"]["data"][1]["nb"]) : 0;
                    var nbEpiqueInv = (datas["data"]["qualite_neutre_inventaire"]["data"][1] != undefined) ? parseInt(datas["data"]["qualite_neutre_inventaire"]["data"][1]["nb"]) : 0;

                    var nbLegColl = (datas["data"]["qualite_neutre"]["data"][2] != undefined) ? parseInt(datas["data"]["qualite_neutre"]["data"][2]["nb"]) : 0;
                    var nbLegInv = (datas["data"]["qualite_neutre_inventaire"]["data"][2] != undefined) ? parseInt(datas["data"]["qualite_neutre_inventaire"]["data"][2]["nb"]) : 0;

                    var vSeries = [{
                                name: 'Commune',
                                color: $.Oda.App.colorCard.Commune,
                                data: [nbCommColl, nbCommInv]
                            },{
                                name: 'Rare',
                                color: $.Oda.App.colorCard.Rare,
                                data: [nbRareColl, nbRareInv]
                            },{
                                name: 'Épique',
                                color: $.Oda.App.colorCard.Épique,
                                data: [nbEpiqueColl, nbEpiqueInv]
                            },{
                                name: 'Légendaire',
                                color: $.Oda.App.colorCard.Légendaire,
                                data: [nbLegColl, nbLegInv]
                            }]
                            ;

                    var retour = $('#div_metrics_collection_neutre').highcharts({
                        chart: {
                            backgroundColor:'rgba(255, 255, 255, 0.1)'
                            , type : "column"
                        },
                        title: {
                            text: 'Répartition des cartes neutre en qualité'
                        },
                        xAxis: {
                            categories: ['Neutre', 'Neutre']
                        },
                        yAxis: {
                            min: 0,
                            title: {
                                text: 'Par qualitée'
                            },
                            stackLabels: {
                                enabled: true,
                                style: {
                                    fontWeight: 'bold',
                                    color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
                                }
                            }
                        },
                        legend: {
                            align: 'right',
                            x: -70,
                            verticalAlign: 'top',
                            y: 20,
                            floating: true,
                            backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColorSolid) || 'white',
                            borderColor: '#CCC',
                            borderWidth: 1,
                            shadow: false
                        },
                        tooltip: {
                            useHTML: true,
                            formatter: function() {
                                var s = this.key+','+this.series.name +' : '+this.y+', '+$.Oda.Tooling.arrondir((this.y / this.point.stackTotal * 100),2)+'% (<a href="javascript:openMissedCards({\'classe\':\''+this.key+'\',\'qualite\':\''+this.series.name+'\'});">Manquante(s)</a>)';
                                return s;
                            }
                        },
                        plotOptions: {
                            column: {
                                stacking: 'normal',
                                dataLabels: {
                                    enabled: true,
                                    color: 'white',
                                    formatter: function() {
                                        var s;
                                        if(this.y != 0){
                                            s = this.y;
                                        }
                                        return s;
                                    }
                                }
                            }
                        },
                        series : vSeries
                    });
                } else{
                    $.Oda.Display.Notification.error(datas["strErreur"]);
                }
            }};
            var tabInput = { code_user : $.Oda.Session.code_user, set : $.Oda.App.tab_sets[$.Oda.Storage.get('ODA-HOW_currentSet')] };
            $.Oda.Interface.callRest($.Oda.Context.rest+"phpsql/getMetricsCollectionNeutre.php", tabSetting, tabInput);
        } catch (er) {
            $.Oda.Log.error("ERROR(chargerMetricsCollectionNeutre :" + er.message);
        }
    }

    /**
     * chargerMetricsPaquets
     */
    function chargerMetricsPaquets(){
        try {
            $.Oda.Display.loading({elt : $('#div_metrics_paquets')});
            var tabSetting = { functionRetour : function(datas){
                if(datas["strErreur"] == ""){

                    var pieDbDatas = datas["data"]["repartitionQualite"]["data"];
                    var pieDatas = new Array();
                    for (var indice in pieDbDatas) {
                        pieDatas[pieDatas.length] = {
                            name : pieDbDatas[indice]["qualite"],
                            color : $.Oda.App.colorCard[pieDbDatas[indice]["qualite"]],
                            y : parseInt(pieDbDatas[indice]["nb"])
                        };
                    }

                    // Create the chart
                    $('#div_metrics_paquets').highcharts({
                        chart: {
                            type: 'pie',
                            backgroundColor:'rgba(255, 255, 255, 0.1)'
                        },
                        title: {
                            text: 'Taux de drop par qualité'
                        },
                        subtitle :  {
                            text : 'From : '+datas["data"]["nbpaquets"]['nb']
                        },
                        plotOptions: {
                            pie: {
                                shadow: true,
                                center: ['50%', '50%']
                            }
                        },
                        tooltip: {
                            formatter: function() {
                                var s;
                                s = this.point.name +' : '+$.Oda.Tooling.arrondir(this.point.percentage,2)+"% ("+this.y+")";
                                return s;
                            }
                        },
                        series: [{
                            name: 'Qualité',
                            data: pieDatas,
                            dataLabels: {
                                formatter: function() {
                                    var s;
                                    if (this.point.percentage > 2) { // the pie chart
                                        s = this.point.name +':'+$.Oda.Tooling.arrondir(this.point.percentage,2)+"%";
                                    }
                                    return s;
                                }
                            }
                        }]
                    });

                } else{
                    $.Oda.Display.Notification.error(datas["strErreur"]);
                }
            }};
            var tabInput = { code_user : $.Oda.Session.code_user, set : $.Oda.App.tab_sets[$.Oda.Storage.get('ODA-HOW_currentSet')] };
            $.Oda.Interface.callRest($.Oda.Context.rest+"phpsql/getQualitePaquets.php", tabSetting, tabInput);
        } catch (er) {
            $.Oda.Log.error("chargerMetricsPaquets : " + er.message);
        }
    }

    /**
     * @name chargerDrop
     * @param {string} p_retour
     */
    function chargerDrop(p_qualite){
        try {
            var dbQualite = '';
            switch(p_qualite) {
                case 'classique':
                    dbQualite = 'Commune';
                    break;
                case 'rare':
                    dbQualite = 'Rare';
                    break;
                case 'epique':
                    dbQualite = 'Épique';
                    break;
                case 'legendaire':
                    dbQualite = 'Légendaire';
                    break;
                default:
                    dbQualite = 'Commune';
            }
            $.Oda.Display.loading({elt : $('#div_drop_'+p_qualite)});
            var tabInput = { code_user : $.Oda.Session.code_user, qualite : dbQualite, set : $.Oda.App.tab_sets[$.Oda.Storage.get('ODA-HOW_currentSet')] };
            $.Oda.Interface.callRest($.Oda.Context.rest+"phpsql/getClassementDrop.php", { functionRetour : function(retour){
                if(retour["strErreur"] == ""){
                    var datas = retour["data"]["resultat"]["data"];

                    var strHtml = '';
                    for (var indice in datas) {
                        strHtml += datas[indice]["nb"]+' - <a href="http://www.wowhead.com/hearthstone/card='+datas[indice]["id_link"]+'" style="color: '+$.Oda.App.colorCard[datas[indice]["qualite"]]+';text-decoration: none">'+datas[indice]["nom"]+'</a><br>';
                    }
                    $('#div_drop_'+p_qualite).html(strHtml);
                } else{
                    $.Oda.Display.Notification.error(retour["strErreur"]);
                }
            }}, tabInput);
        } catch (er) {
            $.Oda.Log.error(" chargerDrop : " + er.message);
        }
    }

    /**
     * @name chargerBestPaquets
     */
    function chargerBestPaquets(){
        try {
            $.Oda.Display.loading({elt : $("#div_best_paquets")});
            var tabInput = { code_user : $.Oda.Session.code_user, set : $.Oda.App.tab_sets[$.Oda.Storage.get('ODA-HOW_currentSet')] };
            $.Oda.Interface.callRest($.Oda.Context.rest+"phpsql/bestPaquetes.php", {functionRetour : function(datas){
                if(datas["strErreur"] == ""){
                    var datas = datas["data"]["resultat"]["data"];

                    var strHtml = '<br>';
                    var ite = 0;
                    for (var indice in datas) {
                        if(ite == 0){
                            strHtml += $.Oda.Date.getStrDateTimeFrFromUs(datas[indice]["date_ajout"])+ ' : ';
                        }
                        ite ++;
                        strHtml += '<a href="http://www.wowhead.com/hearthstone/card='+datas[indice]["id_link"]+'" style="color: '+$.Oda.App.colorCard[datas[indice]["qualite"]]+';text-decoration: none">'+datas[indice]["nom"]+'</a>';
                        if(datas[indice]["gold"] == "1"){
                            strHtml += '(Dor&eacute;)';
                        }
                        if(ite == 5){
                            strHtml += '<br>';
                            ite = 0;
                        }else{
                            strHtml += ', ';
                        }
                    }
                    $('#div_best_paquets').html(strHtml);
                }else{
                    $.Oda.Display.Notification.error(datas["strErreur"]);
                }
            }}, tabInput);
        } catch (er) {
            $.functionsLib.log(0, "ERROR(chargerBestPaquets):" + er.message);
        }
    }

    /**
     * Open missed card
     */
    function openMissedCards(p_params){
        try {
            var strhtml = "<oda-loading></oda-loading>";
            $.Oda.Display.Popup.open({label:'Cartes manquantes', details : strhtml});

            var tabSetting = { functionRetour : function(datas){
                if(datas["strErreur"] == ""){
                    var objDataTable = $.Oda.Tooling.objDataTableFromJsonArray(datas["data"]["resultat"]["data"]);
                    var strhtml = '<table cellpadding="0" cellspacing="0" border="0" class="display" id="table_missedCards" style="width: 100%">';
                    $('#oda-popup_content').html(strhtml);

                    var oTable = $('#table_missedCards').dataTable( {
                        "bLengthChange": false,
                        "iDisplayLength": 5,
                        "aaData": objDataTable.data,
                        "aaSorting": [[0,'asc']],
                        "aoColumns": [
                            { "sTitle": "Carte", "width": "10em" },
                            { "sTitle": "Coût", "sClass": "dataTableColCenter", "width": "2em" },
                            { "sTitle": "Type", "width": "3em" }
                        ],
                        "aoColumnDefs": [
                            {
                                mRender: function ( data, type, row ) {
                                    var strHtml = '<a href="http://www.wowhead.com/hearthstone/card='+row[objDataTable.entete["id_link"]]+'" style="color: '+$.Oda.App.colorCard[row[objDataTable.entete["qualite"]]]+';text-decoration: none" target="_blank">'+row[objDataTable.entete["nom"]]+'</a>';
                                    return strHtml;
                                },
                                aTargets: [ 0 ]
                            },
                            {
                                "mRender": function ( data, type, row ) {
                                    return row[objDataTable.entete["cout"]];
                                },
                                "aTargets": [ 1 ]
                            },
                            {
                                "mRender": function ( data, type, row ) {
                                    return row[objDataTable.entete["type"]];
                                },
                                "aTargets": [ 2 ]
                            }
                        ]
                        , "fnDrawCallback": function( oSettings ) {
                            $('#table_missedCards')
                                .removeClass( 'display' )
                                .addClass('table table-striped table-bordered');
                        }
                    });
                } else{
                    $.Oda.Display.Notification.error(datas["strErreur"]);
                }
            }};
            var tabInput = { "code_user" : $.Oda.Session.code_user, "set" : $.Oda.App.tab_sets[$.Oda.Storage.get('ODA-HOW_currentSet')], "classe" : p_params.classe, "qualite" : p_params.qualite };
            $.Oda.Interface.callRest($.Oda.Context.rest+"phpsql/getMissedCards.php", tabSetting, tabInput);
        } catch (er) {
            $.Oda.Log.error("chargerMetricsCollection : " + er.message);
        }
    }

    changerSet($.Oda.Storage.get('ODA-HOW_currentSet',0));

</script>

<style>

</style>